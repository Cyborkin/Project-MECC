input {
  # Apache access (from web container bind)
  file {
    path => "/var/log/apache2/access.log"
    start_position => "beginning"
    sincedb_path => "/usr/share/logstash/data/access.sincedb"
    type => "apache_access"
    codec => plain { charset => "UTF-8" }
  }

  # ModSecurity audit (JSON) from nginx-waf
  file {
    path => "/var/log/modsecurity/audit.log"
    start_position => "beginning"
    sincedb_path => "/usr/share/logstash/data/modsec.sincedb"
    codec => json_lines
    type => "modsecurity_audit"
  }

  # Nginx access (optional, for WAFâ€™s own access log)
  file {
    path => "/var/log/nginx/access.log"
    start_position => "beginning"
    sincedb_path => "/usr/share/logstash/data/nginx_access.sincedb"
    type => "nginx_access"
  }
}

filter {
  if [type] == "apache_access" {
    grok { match => { "message" => "%{COMBINEDAPACHELOG}" } }
    date { match => [ "timestamp" , "dd/MMM/YYYY:HH:mm:ss Z" ] }
  }
  if [type] == "nginx_access" {
    # Nginx "combined" is similar; you can tune this pattern if needed
    grok { match => { "message" => "%{COMBINEDAPACHELOG}" } }
    date { match => [ "timestamp" , "dd/MMM/YYYY:HH:mm:ss Z" ] }
  }
  if [type] == "modsecurity_audit" {
    # Audit log already JSON; you can extract nested fields as needed
  }
}

output {
  opensearch {
    hosts    => ["https://opensearch:9200"]
    user     => "admin"
    password => "FSA_CAPSTONE_final-M3CC!123"
    ssl      => true
    ssl_certificate_verification => false   # lab: accept self-signed
    index    => "honeypot-%{+YYYY.MM.dd}"
  }
  stdout { codec => rubydebug }
}

